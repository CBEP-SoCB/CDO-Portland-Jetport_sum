---
title: "alternative graphics for Portland Jetport Historical Weather Data"
author:  "Curtis C. Bohlen, Casco Bay Estuary Partnership"
date: "11/09/2021"
output:
  github_document:
    toc: true
    fig_width: 7
    fig_height: 5
---

<img
  src="https://www.cascobayestuary.org/wp-content/uploads/2014/04/logo_sm.jpg"
  style="position:absolute;top:10px;right:50px;" />

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = 'center',
                      fig.width = 5, fig.height = 4,
                      collapse = TRUE, comment = "#>")
```

# Install Libraries
```{r}
library(tidyverse)
library(readr)
library(ggthemes)
library(extrafont)

library(CBEPgraphics)
load_cbep_fonts()
theme_set(theme_cbep())
```

# Read Data
```{r}
sibfldnm <- 'Data'
parent <- dirname(getwd())
sibling <- paste(parent,sibfldnm, sep = '/')
fn <- 'longannualdata.csv'

longannualdata <- read_csv(paste(sibling,fn, sep = '/')) %>%
  select(-station) %>%
  mutate(year = as.numeric(format(date, format='%Y'))) %>%
  mutate(cyear = year-1980)
```

Making sense of that data requires looking at the metadata, but here's a list of 
the datatypes included.
```{r}
levels(factor(longannualdata$datatype))
```
And their frequencies.  Most data records are available for all years,  A 
handful, mostly wind related, are inly available more recently.
```{r}
longannualdata %>%
  group_by(datatype) %>%
  summarize(n=n())
```

# Annual Minimum, Maximum and Average Temperature
Codes for Key Temperature records in the downloaded annual data are:
*  TAVG  -- Annual Average Temperature (unweighted; effectively average of 
   monthly averages, of daily maxes and mins.  Note that this means this is not 
   independent of the other two metrics.)
*  EMXT  -- Extreme Maximum Annual Temperature
*  EMNT  -- Extreme Minimum Temperature

Note that in 2015 State of the Bay, we calculated our own annual means, mins and 
maxes from the daily records.

## Testing possible Graphics
That graphic is not very satisfying, as the slopes are difficult to perceive.  I
wonder if it might be better to present these as temperature anomolies, either
from a designated year or from the long term averages.

```{r}
tdata.centered <- longannualdata %>%
  filter(datatype %in% c('TAVG', 'EMXT', 'EMNT')) %>%
  select(-attributes) %>%
  spread(key = datatype, value = value) %>%
  mutate_at(c('TAVG', 'EMXT', 'EMNT'), ~ scale(., scale = FALSE)) %>%
  gather(key = 'datatype', value = 'value', -date, -year, -cyear)
```
geom_smooth() provides a linear model, which is not robust to outliers.  It
looks like we have only one major outlier, that very cold winter in about 1943.
Also, I really don't want the non statistically significant slope on maximum
temperature to show.

So, lets fit linear models and add statistically significant ones to the plot
```{r}
tdata.centered.wide <- tdata.centered %>%
  spread(key = datatype, value = value)
mean.lm <- lm(TAVG~ cyear, data = tdata.centered.wide)
min.lm <- lm(EMNT~ cyear, data = tdata.centered.wide)
max.lm <- lm(EMXT~ cyear, data = tdata.centered.wide)
```

Statistical significance of slope estimates should not change based on
centering, so we don't need to review model results.  What should change here is
simply the paramaterization -- especially the value of the intercepts.  Code
here also relabels the x axis to show years, not "centered years."

Can also fill in anomalies with different colors, as follows.  ()
```{r}
type.labs <- c('Maximum', 'Average', 'Minimum')
names(type.labs) <- c("EMXT", "TAVG", "EMNT")


plt1 <- ggplot(tdata.centered, aes(year, value)) + 
  geom_bar(aes(fill = ifelse(value <0, "red4", "blue")),
           stat = "identity",
           position = "identity") +
  theme_cbep() +
  ggplot2::scale_fill_discrete(name = '', 
                               labels = c('Above Average', 'Below Average')) +
  xlab('Year') +
  ylab('Temperature Anomoly (F)') +
  facet_wrap('datatype', nrow=3, scales = 'fixed', # alternative is "free_y"
             labeller = labeller(datatype = type.labs),
             strip.position = 'right') +
  theme(legend.position = "none")
plt1
```


```{r}
plt2 <- ggplot(tdata.centered, aes(year, value)) + 
  geom_bar(aes(fill = ifelse(value <0, 
                             "Below Average", 
                             "Above Average")),
           stat = "identity",
           position = "identity") +
  theme_cbep() +
  scale_fill_discrete(name = '', 
                      labels = c('Above Average', 'Below Average')) +
  xlab('Year') +
  ylab('Temperature Anomoly (F)') +
  facet_wrap('datatype', nrow=3, scales = 'free_y', # alternative is "fixed"
             labeller = labeller(datatype = type.labs),
             strip.position = 'right') +
  theme(legend.position = "none")
plt2
```

```{r}

lines <- tibble(datatype = c("EMXT", "TAVG", "EMNT"),
               theslope = c(max.lm$coef[2], mean.lm$coef[2], min.lm$coef[2]),
               theintercept = c(max.lm$coef[1] - 1980 *max.lm$coef[2],
                                mean.lm$coef[1] - 1980 *mean.lm$coef[2],
                                min.lm$coef[1] - 1980 *min.lm$coef[2]))

labs <-  tibble(datatype = c("EMXT", "TAVG", "EMNT"),
              ypos1 = c(-4, -8, -4),
              ypos2 = c(-2, -1.5, -5),
              xpos = c(1950, 2000, 2000),
              txt = c("Not Significant",
                       paste(round(mean.lm$coef[2]*10,2), 
                             'degree F', 
                             "per decade"),
                       paste(round(min.lm$coef[2]*10,2), 
                             'degree ', 
                             "per decade"))
)
```

```{r}

plt1 +
  geom_abline(aes(slope = theslope, 
                  intercept = theintercept), 
              data = lines, 
              lty = 2, alpha = 0.75) +
  geom_text(aes(x=xpos, y=ypos1, label=txt), 
            data = labs)

```

```{r}
plt2 +
  geom_abline(aes(slope = theslope, 
                  intercept = theintercept), 
              data = lines, 
              lty = 2) +
  geom_text(aes(x=xpos, y=ypos2, label=txt), 
            data = labs)
ggsave('drafttempanomolies.png')
```
Not clear which is better....
Note that in 2015 State of the Bay, we calculated our own annual means, mins and 
maxes from the daily records.
